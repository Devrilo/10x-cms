<!-- @layout:base -->
<!-- @title:Content Manager - 10xCMS -->

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1>Content Manager</h1>
          <p class="text-muted">Manage your content with workflow</p>
        </div>
        <button id="createContentBtn" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i> Create Content
        </button>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Content Type</label>
              <select class="form-select" id="filterType">
                <option value="">All Types</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">State</label>
              <select class="form-select" id="filterState">
                <option value="">All States</option>
                <option value="draft">Draft</option>
                <option value="in_review">In Review</option>
                <option value="approved">Approved</option>
                <option value="published">Published</option>
                <option value="archived">Archived</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Organization</label>
              <input type="text" class="form-control" id="filterOrg" placeholder="org_xxx" />
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <button class="btn btn-secondary w-100" id="applyFiltersBtn">
                <i class="bi bi-funnel"></i> Apply Filters
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Content List -->
      <div id="contentListContainer">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Loading content...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Content Modal -->
<div class="modal fade" id="createContentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Content</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="createContentForm">
          <div class="mb-3">
            <label for="contentType" class="form-label">Content Type *</label>
            <select class="form-select" id="contentType" required>
              <option value="">Select content type...</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="contentTitle" class="form-label">Title *</label>
            <input type="text" class="form-control" id="contentTitle" required 
              placeholder="Enter content title" />
          </div>

          <div class="mb-3">
            <label for="contentOrganization" class="form-label">Organization ID</label>
            <input type="text" class="form-control" id="contentOrganization" 
              placeholder="e.g. org_456" value="org_default" />
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            After creating, you'll be able to edit all fields based on the schema.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveContentBtn">
          <i class="bi bi-save me-1"></i> Create Content
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Content Modal -->
<div class="modal fade" id="editContentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="editContentTitle">Edit Content</h5>
          <small class="text-muted" id="editContentSubtitle"></small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Main Content Form -->
          <div class="col-md-8">
            <form id="editContentForm">
              <input type="hidden" id="editContentId" />
              
              <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="editContentTitleField" required />
              </div>

              <div id="dynamicFieldsContainer">
                <!-- Dynamic fields based on schema -->
              </div>

              <div class="mb-3">
                <label class="form-label">Change Description</label>
                <input type="text" class="form-control" id="changeDescription" 
                  placeholder="Describe what changed (for version history)" />
              </div>
            </form>
          </div>

          <!-- Sidebar: Workflow & Info -->
          <div class="col-md-4">
            <div class="card mb-3">
              <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle me-1"></i> Content Info
              </div>
              <div class="card-body">
                <div class="mb-2">
                  <small class="text-muted">State:</small>
                  <span id="contentStateDisplay" class="badge">Draft</span>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Version:</small>
                  <span id="contentVersionDisplay">1</span>
                </div>
                <div class="mb-2">
                  <small class="text-muted">Author:</small>
                  <span id="contentAuthorDisplay">-</span>
                </div>
                <div>
                  <small class="text-muted">Last Updated:</small>
                  <span id="contentUpdatedDisplay">-</span>
                </div>
              </div>
            </div>

            <div class="card mb-3">
              <div class="card-header bg-success text-white">
                <i class="bi bi-arrow-repeat me-1"></i> Workflow
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <button class="btn btn-sm btn-outline-primary" id="submitReviewBtn" disabled>
                    <i class="bi bi-send"></i> Submit for Review
                  </button>
                  <button class="btn btn-sm btn-outline-success" id="approveBtn" disabled>
                    <i class="bi bi-check-circle"></i> Approve
                  </button>
                  <button class="btn btn-sm btn-success" id="publishBtn" disabled>
                    <i class="bi bi-cloud-upload"></i> Publish
                  </button>
                  <button class="btn btn-sm btn-outline-warning" id="archiveBtn" disabled>
                    <i class="bi bi-archive"></i> Archive
                  </button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <i class="bi bi-clock-history me-1"></i> Version History
              </div>
              <div class="card-body p-0">
                <div id="versionHistoryList" style="max-height: 200px; overflow-y: auto;">
                  <p class="text-muted small text-center p-3">No versions yet</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="updateContentBtn">
          <i class="bi bi-save me-1"></i> Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = '/api/v2';
let contentTypes = [];
let contentItems = [];
let currentContent = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadContentTypes();
  loadContent();
  
  document.getElementById('createContentBtn').addEventListener('click', openCreateModal);
  document.getElementById('saveContentBtn').addEventListener('click', createContent);
  document.getElementById('applyFiltersBtn').addEventListener('click', loadContent);
  document.getElementById('updateContentBtn').addEventListener('click', updateContent);
  
  // Workflow buttons
  document.getElementById('submitReviewBtn').addEventListener('click', () => changeState('in_review'));
  document.getElementById('approveBtn').addEventListener('click', () => changeState('approved'));
  document.getElementById('publishBtn').addEventListener('click', publishContent);
  document.getElementById('archiveBtn').addEventListener('click', () => changeState('archived'));
});

// Load content types
async function loadContentTypes() {
  try {
    const response = await fetch(`${API_BASE}/content-types`);
    const data = await response.json();
    contentTypes = data.contentTypes || data.data || [];
    
    // Populate dropdowns
    const selects = [document.getElementById('contentType'), document.getElementById('filterType')];
    selects.forEach(select => {
      if (select.id === 'filterType') {
        select.innerHTML = '<option value="">All Types</option>';
      } else {
        select.innerHTML = '<option value="">Select content type...</option>';
      }
      contentTypes.forEach(type => {
        select.innerHTML += `<option value="${type.id}">${type.displayName}</option>`;
      });
    });
  } catch (error) {
    console.error('Error loading content types:', error);
  }
}

// Load content
async function loadContent() {
  const typeFilter = document.getElementById('filterType').value;
  const stateFilter = document.getElementById('filterState').value;
  const orgFilter = document.getElementById('filterOrg').value.trim();
  
  let url = `${API_BASE}/content?`;
  if (typeFilter) url += `typeId=${typeFilter}&`;
  if (stateFilter) url += `state=${stateFilter}&`;
  if (orgFilter) url += `organizationId=${orgFilter}&`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    contentItems = data.content || [];
    renderContentList();
  } catch (error) {
    console.error('Error loading content:', error);
    showError('Failed to load content');
  }
}

// Render content list
function renderContentList() {
  const container = document.getElementById('contentListContainer');
  
  if (contentItems.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
        <p class="mt-3 text-muted">No content found. Create your first content!</p>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Title</th>
            <th>Type</th>
            <th>State</th>
            <th>Version</th>
            <th>Author</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${contentItems.map(item => {
            const type = contentTypes.find(t => t.id === item.typeId);
            const stateColor = {
              draft: 'secondary',
              in_review: 'info',
              approved: 'success',
              published: 'primary',
              archived: 'warning'
            }[item.state] || 'secondary';
            
            return `
              <tr onclick="editContent('${item.id}')" style="cursor: pointer;">
                <td>
                  <strong>${escapeHtml(item.title)}</strong>
                  ${item.metadata?.publishedAt ? '<i class="bi bi-globe text-primary ms-1" title="Published"></i>' : ''}
                </td>
                <td><span class="badge bg-light text-dark">${type ? type.displayName : 'Unknown'}</span></td>
                <td><span class="badge bg-${stateColor}">${item.state}</span></td>
                <td>${item.currentVersion}</td>
                <td><small>${escapeHtml(item.authorId)}</small></td>
                <td><small>${new Date(item.updatedAt).toLocaleDateString()}</small></td>
                <td onclick="event.stopPropagation()">
                  <button class="btn btn-sm btn-outline-primary" onclick="editContent('${item.id}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteContent('${item.id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// Open create modal
function openCreateModal() {
  document.getElementById('createContentForm').reset();
  document.getElementById('contentOrganization').value = 'org_default';
  new bootstrap.Modal(document.getElementById('createContentModal')).show();
}

// Create content
async function createContent() {
  const typeId = document.getElementById('contentType').value;
  const title = document.getElementById('contentTitle').value.trim();
  const organizationId = document.getElementById('contentOrganization').value.trim();
  
  if (!typeId || !title) {
    showError('Content type and title are required');
    return;
  }
  
  // Get the content type to prepare data with all required fields
  const type = contentTypes.find(t => t.id === typeId);
  if (!type) {
    showError('Content type not found');
    return;
  }
  
  // Build data object with default values for all required fields
  const data = { title };
  type.fields.forEach(field => {
    if (field.required && !data[field.name]) {
      // Set default values based on field type
      switch (field.type) {
        case 'string':
        case 'richText':
          data[field.name] = '';
          break;
        case 'number':
          data[field.name] = 0;
          break;
        case 'boolean':
          data[field.name] = false;
          break;
        case 'date':
          data[field.name] = new Date().toISOString().split('T')[0];
          break;
        case 'array':
          data[field.name] = [];
          break;
        case 'object':
          data[field.name] = {};
          break;
        default:
          data[field.name] = null;
      }
    }
  });
  
  const payload = {
    typeId,
    title,
    data,
    authorId: 'user_demo_' + Date.now(),
    organizationId: organizationId || 'org_default'
  };
  
  try {
    console.log('Creating content with payload:', payload);
    const response = await fetch(`${API_BASE}/content`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    console.log('Response status:', response.status);
    const data = await response.json();
    console.log('Response data:', data);
    
    if (!response.ok) {
      // Show detailed validation errors
      if (data.errors && Array.isArray(data.errors)) {
        const errorDetails = data.errors.map(e => `- ${e.field}: ${e.message}`).join('\n');
        throw new Error(`${data.error}\n\n${errorDetails}`);
      }
      throw new Error(data.error || 'Failed to create content');
    }
    
    showSuccess('Content created successfully');
    bootstrap.Modal.getInstance(document.getElementById('createContentModal')).hide();
    loadContent();
    
    // Open edit modal immediately
    setTimeout(() => editContent(data.content.id), 500);
  } catch (error) {
    console.error('Error creating content:', error);
    showError(error.message);
  }
}

// Edit content
async function editContent(contentId) {
  try {
    const response = await fetch(`${API_BASE}/content/${contentId}`);
    const data = await response.json();
    currentContent = data.content;
    
    // Set basic info
    document.getElementById('editContentId').value = currentContent.id;
    document.getElementById('editContentTitle').textContent = currentContent.title;
    document.getElementById('editContentTitleField').value = currentContent.title;
    
    const type = contentTypes.find(t => t.id === currentContent.typeId);
    document.getElementById('editContentSubtitle').textContent = type ? type.displayName : 'Unknown Type';
    
    // Update info panel
    document.getElementById('contentStateDisplay').textContent = currentContent.state;
    document.getElementById('contentStateDisplay').className = `badge bg-${getStateColor(currentContent.state)}`;
    document.getElementById('contentVersionDisplay').textContent = currentContent.currentVersion;
    document.getElementById('contentAuthorDisplay').textContent = currentContent.authorId;
    document.getElementById('contentUpdatedDisplay').textContent = new Date(currentContent.updatedAt).toLocaleString();
    
    // Render dynamic fields
    renderDynamicFields(type, currentContent.data);
    
    // Load version history
    loadVersionHistory(contentId);
    
    // Update workflow buttons
    updateWorkflowButtons(currentContent.state);
    
    new bootstrap.Modal(document.getElementById('editContentModal')).show();
  } catch (error) {
    console.error('Error loading content:', error);
    showError('Failed to load content');
  }
}

// Render dynamic fields
function renderDynamicFields(type, data) {
  const container = document.getElementById('dynamicFieldsContainer');
  if (!type) {
    container.innerHTML = '<p class="text-muted">Schema not found</p>';
    return;
  }
  
  container.innerHTML = type.fields.map(field => {
    const value = data[field.name] || '';
    const required = field.required ? '*' : '';
    
    let input = '';
    switch (field.type) {
      case 'richText':
        input = `<textarea class="form-control dynamic-field" data-field="${field.name}" rows="5">${escapeHtml(value)}</textarea>`;
        break;
      case 'number':
        input = `<input type="number" class="form-control dynamic-field" data-field="${field.name}" value="${value}" />`;
        break;
      case 'boolean':
        input = `<input type="checkbox" class="form-check-input dynamic-field" data-field="${field.name}" ${value ? 'checked' : ''} />`;
        break;
      case 'date':
        input = `<input type="date" class="form-control dynamic-field" data-field="${field.name}" value="${value}" />`;
        break;
      default:
        input = `<input type="text" class="form-control dynamic-field" data-field="${field.name}" value="${escapeHtml(value)}" />`;
    }
    
    return `
      <div class="mb-3">
        <label class="form-label">${escapeHtml(field.displayName || field.name)} ${required}</label>
        ${field.description ? `<small class="text-muted d-block">${escapeHtml(field.description)}</small>` : ''}
        ${input}
      </div>
    `;
  }).join('');
}

// Update content
async function updateContent() {
  const contentId = document.getElementById('editContentId').value;
  const title = document.getElementById('editContentTitleField').value.trim();
  const changeDescription = document.getElementById('changeDescription').value.trim();
  
  // Collect dynamic field data
  const data = { title };
  document.querySelectorAll('.dynamic-field').forEach(field => {
    const fieldName = field.dataset.field;
    if (field.type === 'checkbox') {
      data[fieldName] = field.checked;
    } else {
      data[fieldName] = field.value;
    }
  });
  
  const payload = {
    title,
    data,
    changeDescription: changeDescription || 'Content updated'
  };
  
  try {
    const response = await fetch(`${API_BASE}/content/${contentId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) throw new Error('Failed to update content');
    
    showSuccess('Content updated successfully (new version created)');
    editContent(contentId); // Reload to show new version
    loadContent(); // Refresh list
  } catch (error) {
    console.error('Error updating content:', error);
    showError(error.message);
  }
}

// Change state
async function changeState(newState) {
  const contentId = document.getElementById('editContentId').value;
  
  try {
    const response = await fetch(`${API_BASE}/content/${contentId}/state`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        state: newState,
        userId: 'user_demo_' + Date.now()
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to change state');
    }
    
    showSuccess(`State changed to: ${newState}`);
    editContent(contentId); // Reload
    loadContent(); // Refresh list
  } catch (error) {
    console.error('Error changing state:', error);
    showError(error.message);
  }
}

// Publish content
async function publishContent() {
  const contentId = document.getElementById('editContentId').value;
  
  try {
    const response = await fetch(`${API_BASE}/content/${contentId}/publish`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        userId: 'publisher_' + Date.now()
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to publish');
    }
    
    showSuccess('Content published successfully! üéâ');
    editContent(contentId); // Reload
    loadContent(); // Refresh list
  } catch (error) {
    console.error('Error publishing content:', error);
    showError(error.message);
  }
}

// Load version history
async function loadVersionHistory(contentId) {
  try {
    const response = await fetch(`${API_BASE}/content/${contentId}/versions`);
    const data = await response.json();
    const versions = data.versions || [];
    
    const container = document.getElementById('versionHistoryList');
    if (versions.length === 0) {
      container.innerHTML = '<p class="text-muted small text-center p-3">No versions yet</p>';
      return;
    }
    
    container.innerHTML = versions.map(v => `
      <div class="border-bottom p-2">
        <div class="d-flex justify-content-between align-items-start">
          <strong class="small">v${v.version}</strong>
          <small class="text-muted">${new Date(v.createdAt).toLocaleDateString()}</small>
        </div>
        <small class="text-muted">${escapeHtml(v.changeDescription || 'No description')}</small>
      </div>
    `).join('');
  } catch (error) {
    console.error('Error loading version history:', error);
  }
}

// Update workflow buttons
function updateWorkflowButtons(state) {
  const submitBtn = document.getElementById('submitReviewBtn');
  const approveBtn = document.getElementById('approveBtn');
  const publishBtn = document.getElementById('publishBtn');
  const archiveBtn = document.getElementById('archiveBtn');
  
  // Reset all
  [submitBtn, approveBtn, publishBtn, archiveBtn].forEach(btn => btn.disabled = true);
  
  // Enable based on state
  if (state === 'draft') {
    submitBtn.disabled = false;
  } else if (state === 'in_review') {
    approveBtn.disabled = false;
  } else if (state === 'approved') {
    publishBtn.disabled = false;
  }
  
  // Archive available for non-archived
  if (state !== 'archived') {
    archiveBtn.disabled = false;
  }
}

// Delete content
async function deleteContent(contentId) {
  if (!confirm('Are you sure you want to delete this content?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/content/${contentId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to delete');
    
    showSuccess('Content deleted successfully');
    loadContent();
  } catch (error) {
    console.error('Error deleting content:', error);
    showError('Failed to delete content');
  }
}

// Utility functions
function getStateColor(state) {
  const colors = {
    draft: 'secondary',
    in_review: 'info',
    approved: 'success',
    published: 'primary',
    archived: 'warning'
  };
  return colors[state] || 'secondary';
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showSuccess(message) {
  alert('‚úÖ ' + message);
}

function showError(message) {
  alert('‚ùå ' + message);
}
</script>

<style>
.table tbody tr:hover {
  background-color: #f8f9fa;
}

.modal-xl {
  max-width: 1200px;
}

#versionHistoryList {
  font-size: 0.875rem;
}
</style>
